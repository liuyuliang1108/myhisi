<style>
    /* 防止下拉框的下拉列表被隐藏---必须设置--- */
    .layui-table-cell {            overflow: visible !important;        }
    /* 使得下拉框与单元格刚好合适 */
    td .layui-form-select{
        margin-top: -10px;
        margin-left: -15px;
        margin-right: -15px;
    }
</style>


<table id="dataTable" lay-filter="fieldList" class="layui-table"></table>

{include file="block/layui" /}
<script type="text/html" id="toolbar">
    <div class="layui-btn-group fl">
        <a data-href="{:url('statusRole?val=1')}" class="layui-btn layui-btn-primary layui-btn-sm j-page-btns layui-icon layui-icon-play" data-table="dataTable">&nbsp;启用</a>
        <a data-href="{:url('statusRole?val=0')}" class="layui-btn layui-btn-primary layui-btn-sm j-page-btns layui-icon layui-icon-pause" data-table="dataTable">&nbsp;禁用</a>
        <a data-href="{:url('delRole')}" class="layui-btn layui-btn-primary layui-btn-sm j-page-btns confirm layui-icon layui-icon-close red">&nbsp;删除</a>
        <button class="layui-btn layui-btn-primary layui-btn-sm j-page-btns layui-icon layui-icon-play" lay-event="tags">&nbsp;生成tags</button>
    </div>
</script>


<script type="text/html" id="typeTpl">
    <a lay-event="select-tpl"></a><select name='ftid' lay-verify='' lay-filter="select-tpl">
            {{d.fieldOption}}
        </select>
</script>

<script type="text/html" id="statusTpl">
    <input type="checkbox" name="status" value="{{ d.status }}" lay-skin="switch" lay-filter="switchStatus" lay-text="正常|关闭" {{ d.status == 1 ? 'checked' : '' }} data-href="{:url('statusRole')}?id={{ d.id }}">
</script>

<script type="text/html" title="操作按钮模板" id="buttonTpl">

    <a class="layui-btn layui-btn-xs" lay-event="save">保存</a>
</script>
<script type="text/javascript">
    layui.use(['form','layer','table','laytpl'], function() {
        var table = layui.table,
        form=layui.form,
        layer=layui.layer,
        $=layui.jquery,
            laytpl = layui.laytpl,
            dataTableId = "dataTableId";

        table.render({
            elem: '#dataTable'
            ,url: '{:url('fieldlist')}?mid={$mid}'//数据接口
            ,skin: 'row'
            ,even: true
            ,text: {
                none : '暂无相关数据'
            }
            ,toolbar: '#toolbar'
            ,defaultToolbar: ['filter']
            ,cols: [[ //表头
                {type:'checkbox'}
                ,{field: 'id', title: 'id'}
                ,{field: 'title', title: '字段注释'}
                ,{field: 'name', title: '字段名称'}
                ,{field: 'ftid',title: '字段类型外键', templet: '#typeTpl'}
                //,{field: 'ftid', title: '字段类型外键'}
                ,{field: 'json_data', title: 'json数据'}
                ,{field: 'tags', title: '标签'}
                ,{field: 'field_order', title: '字段排序',edit:'text'}
                ,{field: 'tips', title: '字段提示',edit:'text'}
                ,{field: 'mid', title: '关联模型外键'}
                ,{field: 'status', title: '状态', templet: '#statusTpl'}
                ,{title: '操作', templet: '#buttonTpl'}
            ]]
            ,id: dataTableId
        });
     //   updateCacheOrForm("dataTable", "dataTableId", "form");
        //定义事件集合
        var active = {
            updateRow: function(obj){
                var oldData = table.cache[dataTableId];
                console.log(oldData);
                for(var i=0, row; i < oldData.length; i++){
                    row = oldData[i];
                    if(row.tempId == obj.tempId){
                        $.extend(oldData[i], obj);
                        return;
                    }
                }
                tableIns.reload({
                    data : oldData
                });
            },
        };
        //激活事件
        var activeByType = function (type, arg) {
            if(arguments.length === 2){
                active[type] ? active[type].call(this, arg) : '';
            }else{
                active[type] ? active[type].call(this) : '';
            }
        };

        //注册按钮事件
        $('.layui-btn[data-type]').on('click', function () {
            var type = $(this).data('type');
            console.log(type);
            activeByType(type);
        });
        //监听单元格编辑
        table.on('edit(fieldList)', function(obj){
            var value = obj.value //得到修改后的值
                ,data = obj.data //得到所在行所有键值
                ,field = obj.field; //得到字段
            layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改为：'+ value);
        });

        table.on('tool(fieldList)', function(obj){

            var data = obj.data,//获取当前行数据
                event = obj.event, tr = obj.tr; //获得当前行 tr 的DOM对象;
           //console.log(data);
            switch(event){
                case "save":
                  console.log(data);
                    $.post("{:url('mycms/mymodel/editField')}",{data:data},function(data){
                        var icon=5;
                        if(data.code){
                            icon=6;
                        }
                        layer.msg(data.msg, {icon:icon,time: 1500});
                    });
                    break;
                case "select-tpl":
                    //console.log(data);
                    var select = tr.find("select[name='ftid']");
                    if(select){
                        var selectedVal = select.val();
                        if(!selectedVal){
                            layer.tips("请选择一个分类", select.next('.layui-form-select'), { tips: [3, '#FF5722'] }); //吸附提示
                        }
                        console.log(selectedVal);
                        $.extend(obj.data, {'select-tpl': selectedVal});//为jQuery对象添加方法
                        activeByType('updateRow', obj.data);	//更新行记录对象
                    }
                    break;
            }
        });
        table.on('toolbar(fieldList)', function(obj){
            var layEvent = obj.event;//获取事件
            var data = table.checkStatus('dataTable').data;
            console.log(data);
            if(layEvent === 'tags'){ //增加tags
                $.post("{:url('mycms/mymodel/tags')}",{data:data,mid:{$mid}},function(data){
                    var icon=5;
                    if(data.code){
                        icon=6;
                    }
                    layer.msg(data.msg, {icon:icon,time: 1500});
                })
            }

        });

        form.on('select(select-tpl)', function(obj){
            //存入table缓存中
            var elem = obj.elem //得到select原始DOM对象
                ,value = obj.value,
                oldData = table.cache[dataTableId];
            var tableIndex=$(elem).closest('tr').attr('data-index');//得到行索引
            for(var i=0, row; i < oldData.length; i++){
                row = oldData[i];
                if(i== tableIndex){
                    oldData[i]['ftid']=value;
                    console.log(oldData);
                }
            }
            //  console.log(oldData);
        });

       function tags(){
           var data=table.checkStatus('fieldList').data;
           console.log(data);
           $.post("{:url('tags')}",{data:data,mid:{$mid}},function(data){
               var icon=5;
               if(data.code){
                   icon=6;
               }
               layer.msg(data.msg, {icon:icon,time: 1500});
           })
       }

    });


</script>